#shopt -s globstar viene usato per usare il ./**/*.typ nella shell

name: Deploy GitHub Page

on:
  push:
    branches:
      - main

jobs:
  compile_typst:
    name: PDF compilation
    runs-on: ubuntu-latest
    steps: 
      - name: Checkout codebase
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Setup Typst
        uses: typst-community/setup-typst@v3

      - name: Compile .typ files
        run: |
         shopt -s globstar
         for file in ./**/*.typ; do
          if [[ "$file" != ./templates/* ]]; then
            typst compile --root . "$file"
          fi
         done
         find . -name "*.pdf" -exec bash -c 'path="{}"; mkdir -p ${{ runner.temp }}/$(dirname "$path") && cp "$path" dist/"$path"' \;

      - name: Add dist PDFs
        run: |
         shopt -s globstar
         cd dist
         cp -r * ${{runner.temp}}
        
      - name: Github Pages Directory Listing
        uses: jayanta525/github-pages-directory-listing@v4.0.0
        with:
          FOLDER: ${{runner.temp}}

      - name: Upload static files as artifact
        id: deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{runner.temp}}

  deploy_docs:
    name: Deploy docs in Pages
    needs: compile_typst
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4





